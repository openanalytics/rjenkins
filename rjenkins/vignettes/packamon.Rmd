---
title: "Building R Packages on Jenkins"
subtitle: "with rjenkins and packamon"
author: "Daan Seynaeve, daan.seynaeve@openanalytics.eu"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
logo: "`r oaStyle::oaLogo()`"
output: 
  oaStyle::html_report: default
mainfont: Cantarell
linkcolor: linkColor
urlcolor:  linkColor
bibliography: "`r system.file('templates', 'r.bib', package = 'oaStyle')`" 
---

```{r echo=FALSE}
library(oaStyle)
```

\clearpage


# Creating a connection

## API token

To connect with jenkins remotely, you first need to request an API token.
You can obtain one at [https://ci.openanalytics.eu/me/configure]

Note that is also possible to use your password directly, but it is
generally safer to use a token, since it is useful only when communicating
with jenkins and it can be reset easily.

## Managing your token

As an optional step, you can store your token somewhere to facilitate
future use of the package.

One convenient and secure way to do this is by using the *keyringr*
package, which will make it very easy to retrieve our stored token in R.
Depending on your OS, you will either use the *Gnome Keyring*, the *Windows Data
Protection API* or *macOS Keychain*.

The example below uses the *Gnome Keyring* on *Ubuntu 17.10*, but
the process should be analogous on other setups.

Open a terminal and run the following (replace `<user_name>` with your
OA user)
```
$ sudo apt install libsecret-tools
$ secret-tool store --label='oa jenkins' jenkins ci user <user_name>
```

## The Connection

```{r}
library(rjenkins)
conn <- jenkinsConnection(
    host = "https://ci.openanalytics.eu",
    user = "dseynaeve",
    token = keyringr::decrypt_gk_pw("jenkins ci user dseynaeve"))
```

# Packamon-managed jobs

After the initial setup, change your R working directory to the
local git repository of an R package of your choice. Note that you also
need to give the *OA jenkins* user read access to this same git repository.
You can do so in the interface of [scm.openanalytics.eu].
 
You can create an automated build for all packages in the current
git repository with:

```{r eval=FALSE}
job <- createPackamonJob(conn)
```

This will automatically fetch the remote repository url from your
local git config (based on the `origin` remote and `master` branch,
but you can specify different ones in the arguments of `createPackamonJob`).

By convention, the name of your job will be *<gitNameWithout.git>-<branch>*
 e.g., biosignature-master for repository biosignature.git

# Querying job info

```{r echo=FALSE}
job <- getJob(conn, "rjenkins-master")
```

To see how your job is doing, run

```{r}
summary(job)
```

If you want to investigate in more detail you can read the log output directly:

```{r}
cat(getBuildLog(job))
```

# Scheduling builds

Packamon jobs are set up to check for changes in the git repository
every so often (as of writing, 15 minutes).

However, if you want to manually schedule a build, you can do so with

```{r eval=FALSE}
scheduleBuild(job)
```

or

```{r eval=FALSE}
schedulePolling(job)
```

The difference between both function is that the latter will only trigger a
build if the any changes were pushed to the git repository since the last build.

# Installing R packages from Jenkins

`rjenkins` also includes some tools to install R packages directly from
Jenkins:

```{r eval=FALSE}
install_jenkins(job)
```

This will attempt to install all artifacts with a valid R package archive
name exported from the latest successful build of the given job. If
multiple versions of the same package are exported, only the latest
one will be installed by default. To learn more and to customize the
behaviour, refer to `?install_jenkins`.

Note that Jenkins is not an appropriate distribution platform for packages.
The installation tools presented here are meant to be used in a early
stage of the package development process, when a package is not mature
enough yet to be released into the world.


